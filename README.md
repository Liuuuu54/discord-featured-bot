# 留言精選 Discord Bot

一个专为Discord论坛设计的留言精選机器人，允许楼主将优质留言设为精選，并为被精選用户提供积分奖励。支持月度积分系统和排行榜功能。

## 功能特点

- 🌟 **留言精選**: 楼主可以将优质留言设为精選
- ❌ **精選取消**: 楼主可以取消错误精選并修正积分
- 🏆 **积分系统**: 被精選用户自动获得积分奖励
- 📊 **月度积分**: 每月积分独立计算，自动重置
- 🏆 **总排行榜**: 管理组可查看所有用户总积分排名
- 📊 **月排行榜**: 管理组可查看本月用户活跃度排名
- 📜 **鉴赏申请窗口**: 管理组可创建申请窗口，用户满足条件可获得鉴赏家身份
- 📈 **统计功能**: 查看用户积分和精選统计
- 🛡️ **权限控制**: 只有楼主可以精選留言
- 🔄 **跨帖重复**: 不同帖子中可以重复精選同一用户
- 🌐 **多群组支持**: 支持在多个 Discord 群组中独立运行

## 使用规则

1. **权限限制**: 只有楼主可以精选留言
2. **自我限制**: 不能精选自己的留言
3. **单帖限制**: 每个帖子中每位用户只能被精选一次
4. **跨帖允许**: 跨帖子可以重复精选同一用户
5. **内容要求**: 留言至少10个字符，不能只含表情符号、图片、文件或贴纸
6. **积分奖励**: 每次精选获得1积分
7. **月度重置**: 每月1日积分自动重置

## 🚀 快速開始

### 1. 克隆項目
```bash
git clone <repository-url>
cd dc_bot
```

### 2. 安裝依賴
```bash
pip install -r requirements.txt
```

### 3. 配置環境變量
複製 `env_example.txt` 為 `.env` 並設置您的 Discord Bot Token:

**基本配置**:
```
DISCORD_TOKEN=your_actual_bot_token_here
```

**可选配置**:
```
# 管理组角色名称（支持逗号分隔多个角色）
ADMIN_ROLE_NAMES=管理组,管理员,Admin,Moderator,管理,版主
```

### 4. 創建 Discord 機器人
1. 訪問 [Discord Developer Portal](https://discord.com/developers/applications)
2. 創建新應用並在 "Bot" 部分創建機器人
3. 複製 Token 並設置到環境變量中
4. 啟用以下權限:
   - Send Messages
   - Use Slash Commands
   - Read Message History
   - Embed Links
   - Mention Everyone

### 5. 邀請機器人到服務器
使用以下鏈接邀請機器人（替換 YOUR_BOT_CLIENT_ID）:
```
https://discord.com/api/oauth2/authorize?client_id=YOUR_BOT_CLIENT_ID&permissions=2048&scope=bot%20applications.commands
```

### 6. 運行機器人
```bash
python bot.py
```

## 命令说明

### 🌟 /精选
将指定用户的留言设为精选
- **参数**: 
  - `message_id`: 要精选的留言ID
  - `reason`: 精选原因（可选）
- **权限**: 仅楼主可用
- **内容要求**: 
  - 留言内容至少10个字符
  - 不能只包含表情符号
  - 不能只包含图片、文件或贴纸
  - 不能过于简单或无意义
- **效果**: 
  - 被精选用户获得1积分
  - 自动@提及被精选用户
  - 显示精选原因

### ❌ /精选取消
取消指定留言的精選狀態
- **参数**: 
  - `message_id`: 要取消精選的留言ID
- **权限**: 仅楼主可用
- **效果**: 
  - 移除精選记录
  - 被精選用户积分减少1分
  - 同时减少总积分和月度积分
  - 支持错误精選的修正
  - **自动删除机器人精選通知消息**

### 📊 /积分
查看用户积分和精选统计（支持查看其他用户）
- **参数**: 
  - `user` (可选): 要查看的用户，不填则查看自己
- **显示**: 
  - 当前总积分
  - 被精选次数
  - 引荐人数
  - 分页显示精选记录（每页5条）
  - 包含原帖链接（可点击）、精选者、时间等信息
- **权限**: 
  - 所有积分查看都仅自己可见



### 🏆 /总排行
显示总积分排行榜（仅管理组可用）
- **权限**: 需要管理组角色或管理权限
  - 支持角色名称：可通过环境变量 `ADMIN_ROLE_NAMES` 自定义
  - 默认角色：管理组、管理员、Admin、Moderator、管理、版主
  - 或拥有管理消息权限
  - 或拥有管理员权限
- **显示**: 
  - 所有用户的积分排名（不会重置）
  - 每页显示20个用户
  - 支持分页浏览
  - 积分数量
- **特点**: 仅管理组可见，用于管理监控
- **配置**: 可在 `.env` 文件中自定义管理组角色名称

### 📊 /月排行
显示本月活跃度排行榜（仅管理组可用）
- **权限**: 需要管理组角色或管理权限
  - 支持角色名称：可通过环境变量 `ADMIN_ROLE_NAMES` 自定义
  - 默认角色：管理组、管理员、Admin、Moderator、管理、版主
  - 或拥有管理消息权限
  - 或拥有管理员权限
- **显示**: 
  - 本月所有用户的月度积分排名
  - 每页显示20个用户
  - 支持分页浏览
  - 积分数量
- **特点**: 仅管理组可见，用于查询用户活跃度
- **配置**: 可在 `.env` 文件中自定义管理组角色名称

### 📜 /鉴赏申请窗口
创建鉴赏家申请窗口（仅管理组可用）
- **权限**: 需要管理组角色或管理权限
  - 支持角色名称：可通过环境变量 `ADMIN_ROLE_NAMES` 自定义
  - 默认角色：管理组、管理员、Admin、Moderator、管理、版主
  - 或拥有管理消息权限
  - 或拥有管理员权限
- **功能**: 
  - 创建带有申请按钮的窗口
  - 用户点击按钮自动检查条件
  - 满足条件自动获得鉴赏家身份
- **申请条件**: 
  - 满足以下条件之一即可：
    - 最低积分：可通过环境变量 `APPRECIATOR_MIN_POINTS` 自定义（默认5分）
    - 最低引荐人数：可通过环境变量 `APPRECIATOR_MIN_REFERRALS` 自定义（默认5人）
- **身份组**: 可通过环境变量 `APPRECIATOR_ROLE_NAME` 自定义（默认"鉴赏家"）
- **特点**: 自动创建角色、自动分配身份、防止重复申请
- **配置**: 可在 `.env` 文件中自定义所有参数

### 📈 /帖子统计
查看当前帖子的精选统计（仅对用户本人可见）
- **权限**: 仅在帖子中可用
- **显示**: 
  - 分页显示精选记录（每页5条）
  - 实时计算每条精选留言的表情符号数量
  - 显示最高表情符号数量
  - 包含原帖链接、精选者、时间等信息


## 数据管理

### 数据目录结构
机器人会自动创建以下目录结构：
```
data/
├── featured_messages.db  # SQLite 数据库文件
└── logs/
    └── bot.log          # 机器人运行日志
```

### 数据库结构

机器人使用 SQLite 数据库存储数据，包含以下表:

### user_points (总积分表)
- `user_id`: 用户ID
- `username`: 用户名
- `points`: 总积分
- `created_at`: 创建时间
- `updated_at`: 更新时间

### monthly_points (月度积分表)
- `id`: 记录ID
- `user_id`: 用户ID
- `username`: 用户名
- `points`: 月度积分
- `year_month`: 年月 (格式: YYYY-MM)
- `created_at`: 创建时间
- `updated_at`: 更新时间

### featured_messages (精选记录表)
- `id`: 记录ID
- `guild_id`: 群组ID
- `thread_id`: 帖子ID
- `message_id`: 留言ID
- `author_id`: 留言作者ID
- `author_name`: 留言作者名
- `featured_by_id`: 精选者ID
- `featured_by_name`: 精选者名
- `featured_at`: 精选时间
- `reason`: 精选原因
- `bot_message_id`: 机器人精选通知消息ID

## 文件结构

```
dc_bot/
├── bot.py                    # 主机器人文件
├── config.py                 # 配置文件
├── database.py               # 数据库管理
├── db_checker.py             # 数据库检查工具
├── guild_data_extractor.py   # 群组数据提取工具
├── requirements.txt          # 依赖包
├── env_example.txt           # 环境变量示例
├── README.md                 # 说明文档
├── Dockerfile                # Docker 配置
├── docker-compose.yml        # Docker Compose 配置
├── deploy.sh                 # Docker 部署脚本
├── backup.sh                 # Docker 备份脚本
├── data/                     # 数据目录（自动创建）
│   ├── featured_messages.db  # 数据库文件
│   └── logs/                 # 日志目录
│       └── bot.log          # 机器人运行日志
└── start.bat                 # Windows 启动脚本
```

## 工具说明

### 数据库检查工具
```bash
# 详细检查（默认）
python db_checker.py

# 简单检查
python db_checker.py --simple

# 交互式查询
python db_checker.py --interactive

# 检查特定群组
python db_checker.py --guild 123456789

# 查看帮助
python db_checker.py --help
```

### 群组数据提取工具
```bash
# 列出所有群组
python guild_data_extractor.py list

# 提取指定群组数据（JSON + CSV）
python guild_data_extractor.py 123456789

# 只导出JSON格式
python guild_data_extractor.py 123456789 json

# 只导出CSV格式
python guild_data_extractor.py 123456789 csv

# 只创建独立数据库
python guild_data_extractor.py 123456789 db

# 提取所有群组数据
python guild_data_extractor.py all
```

## 故障排除

### 常见问题

1. **机器人无法启动**
   - 检查环境变量中的 Token 是否正确
   - 确认机器人已正确邀请到服务器
   - 检查数据库文件权限

2. **命令无法使用**
   - 确认机器人有正确的权限
   - 等待几分钟让命令同步完成
   - 检查机器人是否在线

3. **数据库错误**
   - 删除 `data/featured_messages.db` 文件重新启动
   - 使用 `db_checker.py` 检查数据库状态
   - 检查 `data/` 目录权限

4. **月度积分显示异常**
   - 使用 `db_checker.py` 检查月度积分表
   - 确认数据库结构完整



### 日志查看
机器人运行时会输出详细日志，包括:
- 启动信息
- 命令执行记录
- 错误信息
- 数据库操作记录
- 性能监控信息
- 表情符号统计处理时间

**日志文件位置**: `data/logs/bot.log`

## 更新日志

### v1.3.0
- 📜 **鉴赏申请窗口**: 新增 `/鉴赏申请窗口` 命令，管理组可创建申请窗口，用户满足条件可自动获得鉴赏家身份
- ⚙️ **配置优化**: 新增鉴赏家相关配置项，支持通过环境变量自定义申请条件和身份组名称
- 🛡️ **精选质量检查**: 新增留言内容质量检查，防止低质量内容被精选


### v1.2.0
- 📊 **月排行功能**: 新增 `/月排行` 命令，管理组可查看本月所有用户活跃度排行榜（分页显示）
- 🌐 **指令简体化**: 将所有指令名称和描述更新为简体中文，提升用户体验
- 🔧 **数据库优化**: 新增 `get_monthly_ranking_paginated` 方法，支持分页查询月度积分

### v1.1.1
- 🔧 **群组数据提取工具**: 新增 `guild_data_extractor.py`，支持提取指定群组的完整数据，可创建独立数据库文件
- ⚙️ **管理组配置**: `/总排行` 命令的管理组角色名称现在可通过环境变量自定义配置

### v1.1.0
- 🗂️ **数据路径优化**: 数据库和日志文件移至 `data/` 目录，更好的文件组织
- 🗑️ **精选取消增强**: `/精选取消` 命令现在会自动删除机器人的精选通知消息
- 📊 **表情符号统计**: `/帖子统计` 命令新增实时表情符号数量计算功能
- 📝 **日志增强**: 新增性能监控日志，记录处理时间和记录数量
- 🔧 **数据库优化**: 新增 `bot_message_id` 字段，支持机器人消息管理

### v1.0.1
- ✨ 新增 `/精选取消` 命令：楼主可取消错误精选并修正积分
- ✨ 新增 `/总排行` 命令：管理组可查看所有用户总积分排行榜
- 🔧 优化 `/积分` 命令：支持查看其他用户积分

### v1.0.0
- 🌟 基础精选功能
- 📊 积分统计系统
- 🛡️ 权限控制
- ✨ 月度积分系统
- 🏅 排行榜功能
- 📄 分页显示功能
- 🔧 数据库检查工具

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个项目！

## 许可证

MIT License 